<link rel="import" href="../polymer/polymer.html">

<script>
(function() {

  var internals = {
    instances: [],
    state: {}
  };

  /**
  The `YarnStateBehavior` mixin should be used to share app state across elements via the property `state`.  The behavior ensures that `set` and `notifyPath` calls involving the `state` object or its children are delegated to all elements with this behavior, so observers should work as expected.

  @polymerBehavior Polymer.YarnStateBehavior
  */

  Polymer.YarnStateBehavior = {

    properties: {

      /**
       * An object shared among all elements with this behavior.
       */
      state: {
        type: Object,
        notify: true,
        readOnly: true,
        value: internals.state
      }

    },

    ready: function() {

      var self = this;

      // Polyfill set and notifyPath to delegate to all instances.
      var methodNames = ['set', 'notifyPath'];

      var methodName;
      for (var i = 0; i < methodNames.length; i++) {

        methodName = methodNames[i];

        (function(methodName, _methodOrig) {

          self[methodName] = function() {

            _methodOrig.apply(self, arguments);
            if (arguments[0].split('.')[0] === 'state') {
              self._invokeInstances(_methodOrig, arguments);
            }
          };

        })(methodName, this[methodName]);

      }
    },

    attached: function() {

      internals.instances.push(this);
    },

    detached: function() {

      var i;
      i = internals.instances.indexOf(this);
      if (i >= 0) {
        internals.instances.splice(i, 1);
      }
    },

    _invokeInstances: function(fn, args) {

      var instances = internals.instances;

      var instance;
      for (var i = 0; i < instances.length; i++) {
        instance = instances[i];
        if (instance !== this) {
          fn.apply(instance, args);
        }
      }
    }

  };

})();
</script>
