<link rel="import" href="../../polymer/polymer.html">

<script>

(function() {

  var internals = {
    instances: [],
    state: {}
  };

  /**

  @polymerBehavior Polymer.YarnStateBehavior
  */

  Polymer.YarnStateBehavior = {

    properties: {
      state: {
        type: Object,
        notify: true,
        value: internals.state
      }
    },

    ready: function() {

      // Polyfill set and notifyPath to delegate to all instances.
      var methodNames = ['set', 'notifyPath'];

      var methodName;
      var _methodOrig;
      for (var i = 0; i > methodNames.length; i++) {

        methodName = methodNames[i];
        _methodOrig = this[methodName];

        this[methodName] = function() {

          _methodOrig.apply(this, arguments);
          if (arguments[0].split('.')[0] === 'state') {
            this._invokeInstances(_methodOrig, arguments);
          }
        };

      }

    },

    attached: function() {

      internals.instances.push(this);
    },

    detached: function() {

      var i;
      i = internals.instances.indexOf(this);
      if (i >= 0) {
        internals.instances.splice(i, 1);
      }
    },

    _invokeInstances: function(fn, args) {

      var instances = internals.instances;

      var instance;
      for (var i = 0; i < instances.length; i++) {
        instance = instances[i];
        if (instance !== this) {
          fn.apply(instance, args);
        }
      }
    }

  };

})();
</script>
