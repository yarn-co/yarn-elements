<link rel="import" href="../../polymer/polymer.html">

<script>

  (function() {

    var internals = {
      firstLoaded: false
    };

    Polymer.YarnViewBehavior = {

      properties: {

        // Require authentication via state.auth
        authenticate: {
          type: Boolean,
          value: false
        },

        // Reload page when state.auth.isAuthenticated changes
        authReload: {
          type: Boolean,
          value: false
        },

        // Require view to take a minimum amount of time to load
        longLoad: {
          type: Boolean,
          value: false
        },

        // Set length of longLoad behavior in milliseconds
        longLoadMs: {
          type: Number,
          value: 2000
        }

      },

      observers: [
        '_checkAuth(state.auth.status)',
        '_checkAuthReload(state.auth.isAuthenticated)'
      ],

      /*
       * Element should call viewIsReady to
       * set this to true when view is ready to load
       */
      viewReady: false,
      authenticationReady: false,
      longLoadReady: false,
      activePage: false,
      pageLoading: false,

      /* Call enter if ready, otherwise wait to call enter */
      loadView: function() {

        var self = this;

        if (this.viewReady &&
            (this.authenticationReady || !this.authenticate) &&
            (this.longLoadReady || !this.longLoad || !internals.firstLoaded)) {

            this.activePage = true;
            this.async(function() {

              self.enter();
            });
        } else {

            // Report that this view is waiting for something
            this.fire('yarn-view-waiting', { page: this, long: (this.longLoad && internals.firstLoaded) });

            // If view not ready, wait for it
            if (!this.viewReady) {

                this.addEventListener('yarn-view-ready', this.enterOnceReady);
            }

            // If using authentication and auth is not ready, wait for it
            if (!this.authenticationReady && this.authenticate) {

                this.addEventListener('yarn-view-authentication-finished', this.enterOnceReady);
            }

            // If long-loading, waaait for it
            if (!this.longLoadReady && this.longLoad && internals.firstLoaded) {

                this.addEventListener('yarn-view-long-loaded', this.enterOnceReady);

                var self = this;

                this.async(function() {
                  self.longLoadReady = true;
                  self.fire('yarn-view-long-loaded', {page: self});
                }, null, this.longLoadMs);

            }

        }

      },

      /* Call exit with events */
      destroyView: function() {

        this.fire('yarn-view-destroying', {page: this});

        // Reset need for long load.
        this.longLoadReady = false;

        this.activePage = false;
        this.pageLoading = false;
        this.exit();

        this.fire('yarn-view-destroyed', {page: this});
      },

      /* Callback waiting for app-page-ready if view was not ready when loadView was called */
      enterOnceReady: function() {

        var self = this;

        if (this.viewReady) {

            this.removeEventListener('yarn-view-ready', this.enterOnceReady);
        }

        if (this.authenticationReady && this.authenticate) {

            this.removeEventListener('yarn-view-authentication-finished', this.enterOnceReady);
        }

        if (this.longLoadReady && this.longLoad && internals.firstLoaded) {

            this.removeEventListener('yarn-view-long-loaded', this.enterOnceReady);
        }

        if (this.viewReady &&
            (this.authenticationReady || !this.authenticate) &&
            (this.longLoadReady || !this.longLoad || !internals.firstLoaded)) {

          internals.firstLoaded = true;

          this.activePage = true;
          this.async(function() {

            self.enter();
          });
        }

      },

      /* Declare that this view is ready to render. Fire event when viewReady becomes true, triggers enterOnceReady */
      viewIsReady: function() {

        this.viewReady = true;
        this.fire('yarn-view-ready', { page: this });
      },

      /* Report up for loader */
      startLoading: function() {

        if (!this.pageLoading) {

          this.pageLoading = true;
          this.fire('yarn-view-loading', { page: this });
        }
      },

      /* Report up for loader */
      finishLoading: function() {

        if (this.pageLoading) {

          this.pageLoading = false;
          this.fire('yarn-view-loaded', { page: this });
        }
      },

      reload: function() {

        if (this.activePage) {

          this.destroyView();
          this.loadView();
        }
      },

      /* Only methods typically overridden on extension, default noop */
      enter: function() {},
      exit: function() {},

      _checkAuth: function() {

        if (this.authenticate) {

          if (this.state.auth.status == 'finished') {

            this.authenticationReady = true;
            this.fire('yarn-view-authentication-finished', {page: this});
          }

        }
      },

      _checkAuthReload: function() {

        if (this.authReload) {

          this.reload();
        }
      }

    };

  })();

</script>
